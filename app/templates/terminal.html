{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">Terminal: <span class="text-primary">{{ name }}</span></h2>
        <p class="text-muted">Namespace: {{ namespace }} | Container: {{ container }}</p>
    </div>
    <div>
        {% if details.containers|length > 1 %}
        <div class="dropdown d-inline-block me-2">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="containerDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                Switch Container
            </button>
            <ul class="dropdown-menu" aria-labelledby="containerDropdown">
                {% for c in details.containers %}
                <li><a class="dropdown-item"
                        href="{{ url_for('main.terminal_page', namespace=namespace, name=name, container=c.name) }}">{{
                        c.name }}</a></li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        <a href="{{ url_for('main.describe_pod', namespace=namespace, name=name) }}" class="btn btn-secondary">Back to
            Pod</a>
    </div>
</div>

<div class="card bg-dark border-0 shadow-sm">
    <div class="card-body p-0">
        <div id="terminal-container" style="height: 70vh; width: 100%;"></div>
    </div>
</div>

<!-- Xterm.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
            },
            fontFamily: '"SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace',
            fontSize: 14
        });

        // Handle FitAddon which might be exposed differently depending on the build
        let fitAddon;
        if (typeof FitAddon !== 'undefined') {
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
        }

        term.open(document.getElementById('terminal-container'));
        if (fitAddon) fitAddon.fit();

        window.addEventListener('resize', () => {
            if (fitAddon) fitAddon.fit();
        });

        // Connect to WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/pods/terminal/ws/{{ namespace }}/{{ name }}/{{ container }}`;

        console.log('Connecting to WebSocket:', wsUrl);
        const socket = new WebSocket(wsUrl);

        socket.onopen = function () {
            term.write('\r\n\x1b[32m--- Connected to container shell ---\x1b[0m\r\n');
            // Send a newline to get the prompt
            socket.send('\n');
        };

        socket.onmessage = function (event) {
            term.write(event.data);
        };

        socket.onclose = function () {
            term.write('\r\n\x1b[31m--- Connection closed ---\x1b[0m\r\n');
        };

        socket.onerror = function (error) {
            term.write('\r\n\x1b[31m--- WebSocket Error ---\x1b[0m\r\n');
        };

        term.onData(data => {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(data);
            }
        });
    });
</script>
{% endblock %}