{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">Logs: <span class="text-primary">{{ name }}</span></h2>
        <p class="text-muted">Namespace: {{ namespace }}</p>
    </div>
    <a href="{{ url_for('main.pods_list', namespace=namespace) }}" class="btn btn-secondary">Back to Pods</a>
</div>

<pre id="log-output" class="log-terminal"></pre>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logOutput = document.getElementById('log-output');

        // The URL for our streaming endpoint
        const logStreamUrl = "{{ url_for('main.stream_logs', namespace=namespace, name=name) }}";

        // Use EventSource for a simple and efficient way to handle server-sent events
        const eventSource = new EventSource(logStreamUrl);

        // Append new log lines as they arrive from the server
        eventSource.onmessage = function (event) {
            // Create a span for the new line and set its innerHTML to render the ANSI colors
            const newSpan = document.createElement('span');
            newSpan.innerHTML = event.data + "<br>"; // Add line break as ansi2html might not include it
            logOutput.appendChild(newSpan);

            // Auto-scroll to the bottom only if we were already near the bottom
            // This allows the user to scroll up to read history without fighting the auto-scroll
            const isScrolledToBottom = logOutput.scrollHeight - logOutput.clientHeight <= logOutput.scrollTop + 50;
            if (isScrolledToBottom) {
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        };

        // Handle errors, e.g., if the connection is lost
        eventSource.onerror = function (err) {
            logOutput.textContent += "\n--- Connection lost. Reconnecting... ---\n";
            console.error("EventSource failed:", err);
            // The browser will automatically try to reconnect.
        };
    });
</script>
{% endblock %}