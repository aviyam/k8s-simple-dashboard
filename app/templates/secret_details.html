{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Secret Details</h2>
    <a href="{{ url_for('main.secrets_list', namespace=details.namespace) }}" class="btn btn-secondary">Back to
        Secrets</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">{{ details.name }}</h5>
    </div>
    <div class="card-body">
        <dl class="row">
            <dt class="col-sm-3">Namespace</dt>
            <dd class="col-sm-9">{{ details.namespace }}</dd>
            <dt class="col-sm-3">Created</dt>
            <dd class="col-sm-9">{{ details.creation_timestamp }}</dd>
            <dt class="col-sm-3">Type</dt>
            <dd class="col-sm-9">{{ details.type }}</dd>
        </dl>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Data</h5>
    </div>
    <div class="card-body">
        {% for key in details.data.keys() %}
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>{{ key }}</strong>
                <div>
                    <button class="btn btn-sm btn-primary decode-btn me-2" data-key="{{ key }}">Show</button>
                    <button class="btn btn-sm btn-secondary copy-btn" data-key="{{ key }}"
                        style="display: none;">Copy</button>
                </div>
            </div>
            <div class="decoded-content" id="decoded-content-{{ key }}" style="display: none;">
                <div class="p-3 rounded"
                    style="background-color: var(--bg-body); border: 1px solid var(--border-color); max-height: 300px; overflow-y: auto;">
                    <code
                        style="word-break: break-all; white-space: pre-wrap; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.875rem; color: var(--text-main);"></code>
                </div>
            </div>
        </div>
        {% else %}
        <p class="text-muted">This secret contains no data.</p>
        {% endfor %}
    </div>
</div>

<h4 class="mt-4">Events</h4>
<table class="table table-striped table-sm">
    <thead class="table-light">
        <tr>
            <th>Last Seen</th>
            <th>Type</th>
            <th>Reason</th>
            <th>Message</th>
        </tr>
    </thead>
    <tbody>
        {% for event in details.events %}
        <tr>
            <td>{{ event.last_seen }}</td>
            <td><span class="badge bg-{{ 'warning text-dark' if event.type == 'Warning' else 'secondary' }}">{{
                    event.type }}</span></td>
            <td>{{ event.reason }}</td>
            <td>{{ event.message }}</td>
        </tr>
        {% else %}
        <tr>
            <td colspan="4" class="text-center">No events found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script>
    document.querySelectorAll('.decode-btn').forEach(button => {
        button.addEventListener('click', function () {
            const key = this.dataset.key;
            const contentDiv = document.getElementById(`decoded-content-${key}`);
            const codeElement = contentDiv.querySelector('code');
            const copyBtn = this.parentElement.querySelector('.copy-btn');

            // Check if data has been loaded before
            if (codeElement.textContent) {
                // Toggle visibility
                const isHidden = contentDiv.style.display === 'none';
                if (isHidden) {
                    contentDiv.style.display = 'block';
                    copyBtn.style.display = 'inline-block';
                    this.textContent = 'Hide';
                } else {
                    contentDiv.style.display = 'none';
                    copyBtn.style.display = 'none';
                    this.textContent = 'Show';
                }
                return;
            }

            // Fetch and decode data for the first time
            const formData = new FormData();
            formData.append('key', key);

            fetch("{{ url_for('main.decode_secret_data', namespace=details.namespace, name=details.name) }}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.decoded_value) {
                        codeElement.textContent = data.decoded_value;
                        contentDiv.style.display = 'block';
                        copyBtn.style.display = 'inline-block';
                        this.textContent = 'Hide';
                    } else {
                        codeElement.textContent = `Error: ${data.error || 'Could not decode value.'}`;
                        contentDiv.style.display = 'block';
                        this.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    codeElement.textContent = 'An error occurred while fetching the secret.';
                    contentDiv.style.display = 'block';
                    this.disabled = true;
                });
        });
    });

    // Copy button functionality
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function () {
            const key = this.dataset.key;
            const contentDiv = document.getElementById(`decoded-content-${key}`);
            const codeElement = contentDiv.querySelector('code');

            navigator.clipboard.writeText(codeElement.textContent).then(() => {
                const originalText = this.textContent;
                this.textContent = 'Copied!';
                this.classList.remove('btn-secondary');
                this.classList.add('btn-success');

                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('btn-success');
                    this.classList.add('btn-secondary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                this.textContent = 'Failed';
            });
        });
    });
</script>
{% endblock %}