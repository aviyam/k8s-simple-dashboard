{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Secret Details</h2>
    <a href="{{ url_for('main.secrets_list', namespace=details.namespace) }}" class="btn btn-secondary">Back to Secrets</a>
</div>

<div class="card mb-4">
    <div class="card-header"><h5 class="card-title mb-0">{{ details.name }}</h5></div>
    <div class="card-body">
        <dl class="row">
            <dt class="col-sm-3">Namespace</dt><dd class="col-sm-9">{{ details.namespace }}</dd>
            <dt class="col-sm-3">Created</dt><dd class="col-sm-9">{{ details.creation_timestamp }}</dd>
            <dt class="col-sm-3">Type</dt><dd class="col-sm-9">{{ details.type }}</dd>
        </dl>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header"><h5 class="card-title mb-0">Data</h5></div>
    <div class="card-body">
        <table class="table">
            {% for key in details.data.keys() %}
            <tr>
                <td class="align-middle"><strong>{{ key }}</strong></td>
                <td class="text-end">
                    <button class="btn btn-primary btn-sm decode-btn" data-key="{{ key }}">Show</button>
                </td>
            </tr>
            <tr class="decoded-row" id="decoded-row-{{ key }}" style="display: none;">
                <td colspan="2">
                    <pre class="bg-light p-2 rounded"><code></code></pre>
                </td>
            </tr>
            {% else %}
            <tr><td>This secret contains no data.</td></tr>
            {% endfor %}
        </table>
    </div>
</div>

<h4 class="mt-4">Events</h4>
<table class="table table-striped table-sm">
    <thead class="table-light"><tr><th>Last Seen</th><th>Type</th><th>Reason</th><th>Message</th></tr></thead>
    <tbody>
    {% for event in details.events %}
        <tr>
            <td>{{ event.last_seen }}</td>
            <td><span class="badge bg-{{ 'warning text-dark' if event.type == 'Warning' else 'secondary' }}">{{ event.type }}</span></td>
            <td>{{ event.reason }}</td><td>{{ event.message }}</td>
        </tr>
    {% else %}
        <tr><td colspan="4" class="text-center">No events found.</td></tr>
    {% endfor %}
    </tbody>
</table>
<script>
document.querySelectorAll('.decode-btn').forEach(button => {
    button.addEventListener('click', function() {
        const key = this.dataset.key;
        const decodeRow = document.getElementById(`decoded-row-${key}`);
        const codeElement = decodeRow.querySelector('code');

        // Check if data has been loaded before
        if (codeElement.textContent) {
            // Logic to simply toggle visibility
            const isHidden = decodeRow.style.display === 'none';
            if (isHidden) {
                // If it's hidden, show it and set button text to "Hide"
                decodeRow.style.display = 'table-row';
                this.textContent = 'Hide';
            } else {
                // If it's visible, hide it and set button text to "Show"
                decodeRow.style.display = 'none';
                this.textContent = 'Show';
            }
            return;
        }

        // --- Fetch and decode data for the first time ---
        const formData = new FormData();
        formData.append('key', key);

        fetch("{{ url_for('main.decode_secret_data', namespace=details.namespace, name=details.name) }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.decoded_value) {
                codeElement.textContent = data.decoded_value;
                decodeRow.style.display = 'table-row';
                this.textContent = 'Hide'; // Set initial text to "Hide"
            } else {
                codeElement.textContent = `Error: ${data.error || 'Could not decode value.'}`;
                decodeRow.style.display = 'table-row';
                this.disabled = true; // Disable button on error
            }
        })
        .catch(error => {
            console.error('Error:', error);
            codeElement.textContent = 'An error occurred while fetching the secret.';
            decodeRow.style.display = 'table-row';
            this.disabled = true;
        });
    });
});
</script>
{% endblock %}